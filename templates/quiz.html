{% extends "base.html" %}

{% block title %}AI Quiz Challenge | B.Tech Hub{% endblock %}

{% block head %}
{{ super() }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-light: #f3f4f6;
        --card-bg: #ffffff;
        --border-color: #e5e7eb;
        --text-dark: #111827;
        --text-muted: #6b7280;
        --primary-blue: #3b82f6;
        --primary-blue-light: #eff6ff;
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-light);
        color: var(--text-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 1rem;
    }
    
    /* --- Main Layout --- */
    .quiz-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        width: 100%;
        max-width: 900px;
    }
    @media (min-width: 768px) {
        .quiz-layout {
            flex-direction: row;
            align-items: flex-start;
        }
    }

    /* --- Main Quiz Card --- */
    #quiz-card {
        width: 100%;
        flex: 1;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }

    /* --- Option Button Styling --- */
    .option-btn {
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        text-align: left;
        color: var(--text-dark);
        transition: all 0.2s ease;
    }
    .option-btn:hover {
        border-color: #a5b4fc;
    }
    .option-btn.selected {
        background-color: var(--primary-blue-light);
        border-color: var(--primary-blue);
    }

    /* --- Progress Tracker --- */
    #progress-tracker {
        width: 100%;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: center;
    }
    @media (min-width: 768px) {
        #progress-tracker {
            width: 200px;
            flex-direction: column;
            padding: 1.5rem;
        }
    }
    .progress-bubble {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        background-color: #f3f4f6;
        color: var(--text-muted);
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
    }
    .progress-bubble.current {
        background-color: var(--primary-blue-light);
        color: var(--primary-blue);
        border-color: var(--primary-blue);
    }
    .progress-bubble.answered {
        background-color: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }
</style>
{% endblock %}

{% block content %}
<div id="quiz-layout" class="hidden">
    <div id="quiz-card">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <p id="question-counter" class="font-semibold"></p>
            <p id="timer" class="font-semibold text-lg"></p>
        </div>

        <div class="p-6 flex-1">
            <h2 id="question-text" class="text-2xl font-bold mb-6 min-h-[6rem]"></h2>
            <div id="answer-buttons" class="space-y-3"></div>
        </div>

        <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
            <button id="prev-btn" class="px-6 py-2 rounded-lg font-semibold bg-white border-2 border-gray-300 hover:bg-gray-100">Previous</button>
            <button id="next-btn" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">Next</button>
        </div>
    </div>

    <div id="progress-tracker"></div>
</div>

<div id="start-screen" class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg text-center">
    <h1 class="text-3xl font-bold mb-4">AI Quiz Challenge</h1>
    <p class="text-gray-600 mb-6">Test your knowledge with AI-generated questions.</p>
    <button id="start-btn" class="w-full py-3 px-6 rounded-lg font-semibold text-lg bg-blue-600 text-white hover:bg-blue-700">Start Quiz</button>
</div>

<script>
    // --- DOM REFERENCES ---
    const startScreen = document.getElementById('start-screen');
    const startBtn = document.getElementById('start-btn');
    const quizLayout = document.getElementById('quiz-layout');
    const questionCounterElement = document.getElementById('question-counter');
    const timerElement = document.getElementById('timer');
    const questionTextElement = document.getElementById('question-text');
    const answerButtonsElement = document.getElementById('answer-buttons');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const progressTracker = document.getElementById('progress-tracker');

    // --- STATE ---
    let questions = [];
    let currentQuestionIndex = 0;
    let timerInterval;

    // --- INITIALIZE QUIZ ---
    async function startQuiz() {
        startScreen.classList.add('hidden');
        quizLayout.classList.remove('hidden');

        try {
            questions = await fetchQuestions();
            questions.forEach(q => q.selectedAnswer = null); // Add property to store answers
            currentQuestionIndex = 0;
            buildProgressTracker();
            displayQuestion();
        } catch (error) {
            quizLayout.innerHTML = `<p class="text-red-500">Failed to load quiz.</p>`;
        }
    }

    // --- DISPLAY & UI ---
    function buildProgressTracker() {
        progressTracker.innerHTML = '';
        questions.forEach((_, index) => {
            const bubble = document.createElement('div');
            bubble.className = 'progress-bubble';
            bubble.id = `progress-${index}`;
            bubble.innerText = index + 1;
            progressTracker.appendChild(bubble);
        });
    }
    
    function updateProgressTracker() {
        questions.forEach((q, index) => {
            const bubble = document.getElementById(`progress-${index}`);
            bubble.classList.remove('current', 'answered');
            if (index === currentQuestionIndex) {
                bubble.classList.add('current');
            } else if (q.selectedAnswer !== null) {
                bubble.classList.add('answered');
            }
        });
    }
    
    function displayQuestion() {
        const currentQuestion = questions[currentQuestionIndex];
        questionCounterElement.innerText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        questionTextElement.innerText = currentQuestion.question;
        answerButtonsElement.innerHTML = '';

        currentQuestion.answers.forEach((answer, index) => {
            const button = document.createElement('button');
            button.innerText = answer.text;
            button.className = 'option-btn w-full p-4 rounded-lg font-medium';
            button.dataset.index = index;
            if (currentQuestion.selectedAnswer === index) {
                button.classList.add('selected');
            }
            button.addEventListener('click', handleAnswerSelection);
            answerButtonsElement.appendChild(button);
        });
        
        updateProgressTracker();
        updateNavigationButtons();
        startTimer();
    }
    
    // --- HANDLE SELECTION & NAVIGATION ---
    function handleAnswerSelection(event) {
        const selectedIndex = parseInt(event.currentTarget.dataset.index);
        questions[currentQuestionIndex].selectedAnswer = selectedIndex;
        
        // Visually update the selection
        Array.from(answerButtonsElement.children).forEach((btn, index) => {
            btn.classList.toggle('selected', index === selectedIndex);
        });
    }

    function handleNav(direction) {
        if (direction === 'next' && currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
        } else if (direction === 'prev' && currentQuestionIndex > 0) {
            currentQuestionIndex--;
        }
        displayQuestion();
    }

    function updateNavigationButtons() {
        prevBtn.disabled = currentQuestionIndex === 0;
        nextBtn.innerText = currentQuestionIndex === questions.length - 1 ? 'Submit' : 'Next';
    }

    function startTimer() {
        clearInterval(timerInterval);
        let timeLeft = 60; // 60 seconds per question
        timerElement.innerText = `Time: ${timeLeft}`;
        timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.innerText = `Time: ${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                handleNav('next'); // Auto-advance to next question
            }
        }, 1000);
    }

    // --- FETCH QUESTIONS ---
    async function fetchQuestions() {
        // Replace with your actual API fetch
        // const response = await fetch('/api/generate-quiz');
        // return await response.json();
        return [
            { question: "What is the main purpose of a 'constructor' in a class?", answers: [ { text: "To destroy the object", correct: false }, { text: "To initialize a newly created object", correct: true }, { text: "To perform a static operation", correct: false }, { text: "To copy the object", correct: false } ] },
            { question: "Which of the following is a primitive type in JavaScript?", answers: [ { text: "Array", correct: false }, { text: "Object", correct: false }, { text: "Symbol", correct: true }, { text: "Function", correct: false } ] },
            { question: "What does the 'typeof' operator in JavaScript return for `null`?", answers: [ { text: "'null'", correct: false }, { text: "'undefined'", correct: false }, { text: "'object'", correct: true }, { text: "'string'", correct: false } ] }
        ];
    }
    
    // --- EVENT LISTENERS ---
    startBtn.addEventListener('click', startQuiz);
    prevBtn.addEventListener('click', () => handleNav('prev'));
    nextBtn.addEventListener('click', () => {
        if (nextBtn.innerText === 'Submit') {
            clearInterval(timerInterval);
            // Add a function to show results
            alert('Quiz Submitted!'); 
        } else {
            handleNav('next');
        }
    });
</script>
{% endblock %}